ignore:
  - "*.md"

functions:
  setup_virtualenv:
    - command: subprocess.exec
      type: setup
      params:
        working_dir: mongodb-kubernetes-operator
        binary: scripts/ci/setup_virtualenv.sh
        include_expansions_in_env:
          - sonar_github_token

  clone:
    - command: subprocess.exec
      type: setup
      params:
        command: "mkdir -p mongodb-kubernetes-operator"
    - command: git.get_project
      type: setup
      params:
        directory: mongodb-kubernetes-operator

  # upload_e2e_logs has the responsibility of dumping as much information as
  # possible into the S3 bucket
  upload_e2e_logs:
    - command: s3.put
      params:
        aws_key: ${community_aws_access_key_id}
        aws_secret: ${community_aws_secret_access_key}
        local_files_include_filter_prefix: mongodb-kubernetes-operator/logs/
        local_files_include_filter:
          - e2e/*.txt
          - e2e/*.log
          - e2e/*.json
        region: us-east-1
        remote_file: logs/${task_id}/${execution}/
        bucket: community-operator-e2e-logs
        permissions: public-read
        content_type: text/plain

  setup_kubernetes_environment:
    - command: subprocess.exec
      type: setup
      params:
        working_dir: mongodb-kubernetes-operator/scripts/ci
        command: go run download.go
        env:
          URL: https://storage.googleapis.com/kubernetes-release/release/v1.15.4/bin/linux/amd64/kubectl
          FILENAME: kubectl
          DIR: ${workdir}/bin

    - command: subprocess.exec
      type: setup
      params:
        working_dir: mongodb-kubernetes-operator/scripts/ci
        command: go run download.go
        env:
          URL: https://github.com/kubernetes-sigs/kind/releases/download/v0.7.0/kind-linux-amd64
          FILENAME: kind
          DIR: ${workdir}/bin

  create_kind_cluster:
    - command: subprocess.exec
      type: setup
      params:
        add_to_path:
          - ${workdir}/bin
        working_dir: mongodb-kubernetes-operator
        binary: scripts/ci/create_kind_cluster.sh
        env:
          KUBECONFIG: ${workdir}/kube_config

  run_e2e_test:
    - command: subprocess.exec
      type: test
      params:
        working_dir: mongodb-kubernetes-operator
        env:
          KUBECONFIG: ${workdir}/kube_config
        include_expansions_in_env:
          - version_id
          - test
          - clusterwide
          - distro
        binary: scripts/ci/run_test.sh

  python_venv: &python_venv
    command: subprocess.exec
    type: setup
    params:
      command: virtualenv --python /opt/python/3.9/bin/python3 ./venv

  python_requirements: &python_requirements
    command: subprocess.exec
    type: setup
    params:
      working_dir: mongodb-kubernetes-operator
      command: ${workdir}/venv/bin/python -m pip install -r requirements.txt --quiet --no-warn-script-location

  build_and_push_image_sonar:
    - command: subprocess.exec
      type: setup
      params:
        env:
          MONGODB_COMMUNITY_CONFIG: ${workdir}/mongodb-kubernetes-operator/scripts/ci/config.json
          AWS_ACCESS_KEY_ID: ${community_aws_access_key_id}
          AWS_SECRET_ACCESS_KEY: ${community_aws_secret_access_key}
        include_expansions_in_env:
          - version_id
          - quay_user_name
          - quay_password
          - image_name
          - release
        working_dir: mongodb-kubernetes-operator
        binary: scripts/ci/build_and_push_image_sonar.sh


task_groups:
- name: e2e_test_group
  max_hosts: 8
  setup_group:
    - func: clone
    - func: setup_virtualenv
    - func: setup_kubernetes_environment
  setup_task:
    - func: create_kind_cluster
  tasks:
    - e2e_test_replica_set
    - e2e_test_replica_set_recovery
    - e2e_test_replica_set_mongod_readiness
    - e2e_test_replica_set_scale
    - e2e_test_replica_set_scale_down
    - e2e_test_replica_set_change_version
    - e2e_test_feature_compatibility_version
    - e2e_test_feature_compatibility_version_upgrade
    - e2e_test_replica_set_multiple
    - e2e_test_replica_set_tls
    - e2e_test_replica_set_tls_upgrade
    - e2e_test_replica_set_tls_rotate
    - e2e_test_statefulset_arbitrary_config
    - e2e_test_statefulset_arbitrary_config_update
    - e2e_test_replica_set_mongod_config
    - e2e_test_replica_set_cross_namespace_deploy
    - e2e_test_replica_set_custom_role
  teardown_task:
    - func: upload_e2e_logs

tasks:
  - name: build_operator_image
    priority: 60
    exec_timeout_secs: 600
    commands:
      - func: clone
      - func: setup_virtualenv
      - func: build_and_push_image_sonar
        vars:
          image_name: operator-ubi

  - name: build_e2e_image
    priority: 60
    exec_timeout_secs: 600
    commands:
      - func: clone
      - func: setup_virtualenv
      - func: build_and_push_image_sonar
        vars:
          image_name: e2e


  - name: build_agent_image_ubuntu
    priority: 60
    exec_timeout_secs: 600
    commands:
      - func: clone
      - func: setup_virtualenv
      - func: build_and_push_image_sonar
        vars:
          image_name: agent-ubuntu

  - name: build_agent_image_ubi
    priority: 60
    exec_timeout_secs: 600
    commands:
      - func: clone
      - func: setup_virtualenv
      - func: build_and_push_image_sonar
        vars:
          image_name: agent-ubi

  - name: build_prehook_image
    priority: 60
    exec_timeout_secs: 600
    commands:
      - func: clone
      - func: setup_virtualenv
      - func: build_and_push_image_sonar
        vars:
          image_name: version-post-start-hook-init

  - name: build_readiness_probe_image
    priority: 60
    exec_timeout_secs: 600
    commands:
      - func: clone
      - func: setup_virtualenv
      - func: build_and_push_image_sonar
        vars:
          image_name: readiness-probe-init


  - name: e2e_test_feature_compatibility_version
    commands:
      - func: run_e2e_test
        vars:
          test: feature_compatibility_version

  - name: e2e_test_feature_compatibility_version_upgrade
    commands:
      - func: run_e2e_test
        vars:
          test: feature_compatibility_version_upgrade

  - name: e2e_test_replica_set
    commands:
      - func: run_e2e_test
        vars:
          test: replica_set

  - name: e2e_test_replica_set_recovery
    commands:
      - func: run_e2e_test
        vars:
          test: replica_set_recovery

  - name: e2e_test_replica_set_mongod_readiness
    commands:
      - func: run_e2e_test
        vars:
          test: replica_set_mongod_readiness

  - name: e2e_test_replica_set_scale
    commands:
      - func: run_e2e_test
        vars:
          test: replica_set_scale

  - name: e2e_test_replica_set_scale_down
    exec_timeout_secs: 3600
    commands:
      - func: run_e2e_test
        vars:
          test: replica_set_scale_down

  - name: e2e_test_replica_set_change_version
    commands:
      - func: run_e2e_test
        vars:
          test: replica_set_change_version

  - name: e2e_test_replica_set_multiple
    commands:
      - func: run_e2e_test
        vars:
          test: replica_set_multiple

  - name: e2e_test_replica_set_tls
    commands:
      - func: run_e2e_test
        vars:
          test: replica_set_tls

  - name: e2e_test_replica_set_tls_upgrade
    commands:
      - func: run_e2e_test
        vars:
          test: replica_set_tls_upgrade

  - name: e2e_test_replica_set_tls_rotate
    commands:
      - func: run_e2e_test
        vars:
          test: replica_set_tls_rotate

  - name: e2e_test_statefulset_arbitrary_config
    commands:
      - func: run_e2e_test
        vars:
          test: statefulset_arbitrary_config

  - name: e2e_test_statefulset_arbitrary_config_update
    commands:
      - func: run_e2e_test
        vars:
          test: statefulset_arbitrary_config_update

  - name: e2e_test_replica_set_mongod_config
    commands:
      - func: run_e2e_test
        vars:
          test: replica_set_mongod_config

  - name: e2e_test_replica_set_cross_namespace_deploy
    commands:
      - func: run_e2e_test
        vars:
          test: replica_set_cross_namespace_deploy
          clusterwide: true

  - name: e2e_test_replica_set_custom_role
    commands:
      - func: run_e2e_test
        vars:
          test: replica_set_custom_role


buildvariants:
  - name: e2e_tests_ubuntu
    display_name: e2e_tests_ubuntu
    expansions:
      distro: ubuntu
    run_on:
      - ubuntu1804-large
    depends_on:
      - name: build_operator_image
        variant: init_test_run
      - name: build_e2e_image
        variant: init_test_run
      - name: build_prehook_image
        variant: init_test_run
      - name: build_readiness_probe_image
        variant: init_test_run
      - name: build_agent_image_ubuntu
        variant: init_test_run
    tasks:
      - name: e2e_test_group

  - name: e2e_tests_ubi
    display_name: e2e_tests_ubi
    expansions:
      distro: ubi
    run_on:
      - ubuntu1804-large
    depends_on:
      - name: build_operator_image
        variant: init_test_run
      - name: build_e2e_image
        variant: init_test_run
      - name: build_prehook_image
        variant: init_test_run
      - name: build_readiness_probe_image
        variant: init_test_run
      - name: build_agent_image_ubi
        variant: init_test_run
    tasks:
      - name: e2e_test_group

  - name: init_test_run
    display_name: init_test_run
    run_on:
      - ubuntu1804-small
    tasks:
      - name: build_operator_image
      - name: build_e2e_image
      - name: build_prehook_image
      - name: build_agent_image_ubi
      - name: build_agent_image_ubuntu
      - name: build_readiness_probe_image
