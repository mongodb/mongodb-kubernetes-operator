vars:
  registry: <registry>
  s3_bucket_http: https://enterprise-operator-dockerfiles.s3.amazonaws.com/dockerfiles/mongodb-agent
  s3_bucket: s3://enterprise-operator-dockerfiles/dockerfiles/mongodb-agent

images:
  - name: agent-ubuntu
    vars:
      context: .
      template_context: scripts/dev/templates/agent

    inputs:
      - agent_version
      - tools_version

    stages:
      - name: agent-ubuntu-context
        task_type: docker_build
        dockerfile: scripts/dev/templates/agent/Dockerfile.builder
        tags: ["ubuntu"]
        buildargs:
          agent_version: $(inputs.params.agent_version)
          tools_version: $(inputs.params.tools_version)
          agent_distro: linux_x86_64
          tools_distro: ubuntu1604-x86_64

        output:
          - registry: $(inputs.params.registry)/agent-ubuntu-context-dev
            tag: $(inputs.params.version_id)

      - name: agent-template-ubuntu
        task_type: dockerfile_template
        tags: ["ubuntu"]
        distro: ubuntu

        # TODO: remove - this is only here as sonar raises a key error on version_id
        # if no other inputs are specified.
        inputs:
          - noop

        output:
          - dockerfile: scripts/dev/templates/agent/Dockerfile.ubuntu-$(inputs.params.version_id)

      - name: agent-ubuntu-build
        task_type: docker_build
        tags: ["ubuntu"]

        inputs:
          - expire_after

        dockerfile: scripts/dev/templates/agent/Dockerfile.ubuntu-$(inputs.params.version_id)

        buildargs:
          imagebase: $(inputs.params.registry)/agent-ubuntu-context-dev:$(inputs.params.version_id)

        labels:
          quay.expires-after: $(inputs.params.expire_after)

        output:
          - registry: $(inputs.params.registry)/mongodb-agent-ubuntu-dev
            tag: $(inputs.params.version_id)

      - name: agent-template-ubuntu-s3
        task_type: dockerfile_template
        tags: ["ubuntu", "release"]
        distro: ubuntu

        inputs:
          - release_version

        output:
          - dockerfile: $(inputs.params.s3_bucket)/Dockerfile.ubuntu-$(inputs.params.release_version)

      - name: agent-context-ubuntu-release
        task_type: tag_image
        tags: ["ubuntu", "release"]
        distro: ubuntu

        source:
          registry: $(inputs.params.registry)/agent-ubuntu-context-dev
          tag: $(inputs.params.version_id)

        destination:
          - registry: $(inputs.params.registry)/mongodb-agent-ubuntu-context
            tag: $(inputs.params.release_version)-context

  - name: agent-ubi
    vars:
      context: .
      template_context: scripts/dev/templates/agent

    inputs:
      - agent_version
      - tools_version

    stages:
      - name: agent-ubi-context
        task_type: docker_build
        dockerfile: scripts/dev/templates/agent/Dockerfile.builder
        tags: ["ubi"]
        buildargs:
          agent_version: $(inputs.params.agent_version)
          tools_version: $(inputs.params.tools_version)
          agent_distro: rhel7_x86_64
          tools_distro: rhel70-x86_64

        output:
          - registry: $(inputs.params.registry)/agent-ubi-context-dev
            tag: $(inputs.params.version_id)


      - name: agent-template-ubi
        task_type: dockerfile_template
        distro: ubi
        tags: ["ubi"]

        # TODO: remove - this is only here as sonar raises a key error on version_id
        # if no other inputs are specified.
        inputs:
          - noop

        output:
          - dockerfile: scripts/dev/templates/agent/Dockerfile.ubi-$(inputs.params.version_id)


      - name: agent-ubi-build
        task_type: docker_build
        tags: ["ubi"]
        dockerfile: scripts/dev/templates/agent/Dockerfile.ubi-$(inputs.params.version_id)

        buildargs:
          imagebase: $(inputs.params.registry)/agent-ubi-context-dev:$(inputs.params.version_id)

        inputs:
          - expire_after

        labels:
          quay.expires-after: $(inputs.params.expire_after)

        output:
          - registry: $(inputs.params.registry)/mongodb-agent-ubi-dev
            tag: $(inputs.params.version_id)

      - name: agent-template-ubi-s3
        task_type: dockerfile_template
        tags: ["ubi", "release"]
        distro: ubi

        inputs:
          - release_version

        output:
          - dockerfile: $(inputs.params.s3_bucket)/Dockerfile.ubi-$(inputs.params.release_version)

      - name: agent-context-ubi-release
        task_type: tag_image
        tags: ["ubi", "release"]
        distro: ubi

        source:
          registry: $(inputs.params.registry)/agent-ubi-context-dev
          tag: $(inputs.params.version_id)

        destination:
          - registry: $(inputs.params.registry)/mongodb-agent-ubi-context
            tag: $(inputs.params.release_version)-context

  - name: readiness-probe-init
    vars:
      context: .

    stages:
      - name: readiness-init-context-build
        task_type: docker_build
        dockerfile: scripts/dev/templates/readiness/Dockerfile.builder
        tags: ["readiness-probe"]

        output:
          - registry: $(inputs.params.registry)/mongodb-kubernetes-readinessprobe-context-dev
            tag: $(inputs.params.version_id)

      - name: readiness-init-build
        task_type: docker_build
        dockerfile: scripts/dev/templates/readiness/Dockerfile.readiness
        tags: ["readiness-probe"]
        buildargs:
          imagebase: $(inputs.params.registry)/mongodb-kubernetes-readinessprobe-context-dev:$(inputs.params.version_id)

        output:
          - registry: $(inputs.params.registry)/mongodb-kubernetes-readinessprobe-context-dev
            tag: $(inputs.params.version_id)


      - name: readiness-init-context-release
        task_type: tag_image
        tags: ["release", "readiness-probe"]

        inputs:
          - release_version

        source:
          registry: $(inputs.params.registry)/mongodb-kubernetes-readinessprobe-context-dev
          tag: $(inputs.params.version_id)

        destination:
          - registry: $(inputs.params.registry)/mongodb-kubernetes-readinessprobe-context
            tag: $(inputs.params.release_version)


      - name: readiness-init-build-release
        task_type: tag_image
        tags: ["release", "readiness-probe"]

        inputs:
          - release_version

        source:
          registry: $(inputs.params.registry)/mongodb-kubernetes-readinessprobe-dev
          tag: $(inputs.params.version_id)

        destination:
          - registry: $(inputs.params.registry)/mongodb-kubernetes-readinessprobe
            tag: $(inputs.params.release_version)


  - name: version-post-start-hook-init
    vars:
      context: .

    stages:
      - name: version-post-start-hook-init-context-build
        task_type: docker_build
        dockerfile: scripts/dev/templates/versionhook/Dockerfile.builder
        tags: ["post-start-hook"]

        output:
          - registry: $(inputs.params.registry)/mongodb-kubernetes-operator-version-upgrade-post-start-hook-context-dev
            tag: $(inputs.params.version_id)

      - name: version-post-start-hook-init-build
        task_type: docker_build
        dockerfile: scripts/dev/templates/versionhook/Dockerfile.versionhook
        tags: ["post-start-hook"]
        buildargs:
          imagebase: $(inputs.params.registry)/mongodb-kubernetes-operator-version-upgrade-post-start-hook-context-dev:$(inputs.params.version_id)

        output:
          - registry: $(inputs.params.registry)/mongodb-kubernetes-operator-version-upgrade-post-start-hook-dev
            tag: $(inputs.params.version_id)


      - name: version-post-start-hook-init-context-release
        task_type: tag_image
        tags: ["release", "post-start-hook"]

        inputs:
          - release_version

        source:
          registry: $(inputs.params.registry)/mongodb-kubernetes-operator-version-upgrade-post-start-hook-context-dev
          tag: $(inputs.params.version_id)

        destination:
          - registry: $(inputs.params.registry)/mongodb-kubernetes-operator-version-upgrade-post-start-hook-context
            tag: $(inputs.params.release_version)


      - name: version-post-start-hook-init-build-release
        task_type: tag_image
        tags: ["release", "post-start-hook"]

        inputs:
          - release_version

        source:
          registry: $(inputs.params.registry)/mongodb-kubernetes-operator-version-upgrade-post-start-hook-dev
          tag: $(inputs.params.version_id)

        destination:
          - registry: $(inputs.params.registry)/mongodb-kubernetes-operator-version-upgrade-post-start-hook
            tag: $(inputs.params.release_version)
