
##################################################################################
# 
# This file is automatically generated using templates. Changes to this file
# should happen through editing the templates under .action_templates/*
# Manual edits will be overwritten.
#
##################################################################################

name: Run E2E Fork
on:
  # template: .action_templates/events/pull-request-target.yaml
  pull_request_target:
    types: [labeled]
    branches:
    - master
    paths-ignore:
    - docs/**
jobs:
  # template: .action_templates/jobs/display-github-context.yaml
  action-context:
    if: always()
    runs-on: ubuntu-latest
    steps:
    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJSON(github) }}
      run: echo "$GITHUB_CONTEXT"
  # template: .action_templates/jobs/setup.yaml
  setup:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
        - pipeline-argument: operator
        - pipeline-argument: version-upgrade-hook
        - pipeline-argument: readiness-probe
        - pipeline-argument: agent
        - pipeline-argument: e2e
    if: contains(github.event.pull_request.labels.*.name, 'dependencies') || contains(github.event.pull_request.labels.*.name,
      'safe-to-test')
    steps:
    # template: .action_templates/steps/build-and-push-development-images.yaml
    - name: Build and Push Images
      run: |
        python pipeline.py --image-name ${{ matrix.pipeline-argument }}  --tag ${{ github.run_id }}
      env:
        MONGODB_COMMUNITY_CONFIG: ${{ github.workspace }}/scripts/ci/config.json
        version_id: ${{ github.run_id }}
  # template: .action_templates/jobs/tests.yaml
  tests:
    runs-on: ubuntu-latest
    needs: [setup]
    strategy:
      fail-fast: false
      matrix:
        include:
        - test-name: replica_set
          distro: ubi
        - test-name: replica_set_enterprise_upgrade_4_5
          distro: ubi
        - test-name: replica_set_enterprise_upgrade_5_6
          distro: ubi
        - test-name: replica_set_enterprise_upgrade_6_7
          distro: ubi
        - test-name: replica_set_enterprise_upgrade_7_8
          distro: ubi
        - test-name: replica_set_recovery
          distro: ubi
        - test-name: replica_set_mongod_readiness
          distro: ubi
        - test-name: replica_set_scale
          distro: ubi
        - test-name: replica_set_scale_down
          distro: ubi
        - test-name: replica_set_change_version
          distro: ubi
        - test-name: feature_compatibility_version
          distro: ubi
        - test-name: prometheus
          distro: ubi
        - test-name: replica_set_tls
          distro: ubi
        - test-name: replica_set_tls_recreate_mdbc
          distro: ubi
        - test-name: replica_set_tls_rotate
          distro: ubi
        - test-name: replica_set_tls_rotate_delete_sts
          distro: ubi
        - test-name: replica_set_tls_upgrade
          distro: ubi
        - test-name: statefulset_arbitrary_config
          distro: ubi
        - test-name: statefulset_arbitrary_config_update
          distro: ubi
        - test-name: replica_set_mongod_config
          distro: ubi
        - test-name: replica_set_cross_namespace_deploy
          distro: ubi
          cluster-wide: true
        - test-name: replica_set_custom_role
          distro: ubi
        - test-name: replica_set_arbiter
          distro: ubi
        - test-name: replica_set_custom_persistent_volume
          distro: ubi
        - test-name: replica_set_mount_connection_string
          distro: ubi
        - test-name: replica_set_mongod_port_change_with_arbiters
          distro: ubi
        - test-name: replica_set_operator_upgrade
          distro: ubi
        - test-name: replica_set_connection_string_options
          distro: ubi
        - test-name: replica_set_x509
          distro: ubi
        - test-name: replica_set_remove_user
          distro: ubi
    steps:
    # template: .action_templates/steps/save-run-status.yaml
    - name: Save run status
      if: always()
      run: echo "::set-output name=last_run_status::${{ steps.e2e_test.outcome }}"
        > last_run_status
